import "./style.css";
// import { setupCounter } from "./counter.js";

var START_HOUR = 6;
var END_HOUR = 22;
var DAY_LENGTH = END_HOUR - START_HOUR;

function calculateHour(hour) {
  return hour % 12 || 12;
}

function createHourBlock(hour, topPosition) {
  const line = document.createElement("div");
  line.className = "hour_block";
  line.style.top = `${topPosition}px`;
  line.textContent = hour;
  return line;
}

function createActivity(taskStart, taskDuration, taskName) {
  // alert(
  //   `Task Name: ${taskName}\nStart Time: ${taskStart}\nDuration: ${taskDuration} hours`
  // );

  const activity = document.createElement("div");
  activity.className = "activity";
  const startHour = parseTime(taskStart);
  const topPosition = (startHour - START_HOUR) * delta;
  const height = (taskDuration / 60) * delta;
  activity.style.top = `${topPosition}px`;
  activity.style.height = `${height}px`;
  activity.textContent = taskName;

  activity.dataset.start = taskStart;
  activity.dataset.duration = taskDuration;
  activity.dataset.name = taskName;

  const existingActivities = document.querySelectorAll(
    "#timeline_block .activity"
  );
  let overlapCount = 0;
  existingActivities.forEach((existingActivity) => {
    const existingTop = parseFloat(existingActivity.style.top);
    const existingHeight = parseFloat(existingActivity.style.height);
    const existingBottom = existingTop + existingHeight;

    if (topPosition < existingBottom && topPosition >= existingTop) {
      overlapCount++;
    }
  });

  activity.style.left = `${5 * overlapCount}%`;

  activity.addEventListener("click", function () {
    console.log("activity - add event listener");
    showActivityMenu(activity);
  });

  document.querySelector("#timeline_block").appendChild(activity);
}

function showActivityMenu(activity) {
  console.log("activity - show activity menu");
  const menu = document.createElement("div");
  menu.className = "activity_menu";
  menu.innerHTML = `
    <h3>Activity Details</h3>
    <p>Task Name: ${activity.dataset.name}</p>
    <p>Start Time: ${activity.dataset.start}</p>
    <p>Duration: ${activity.dataset.duration} minutes</p>
    <button id="drag">Drag</button>
    <button id="not_me">Not Me</button>
    <button id="dismiss">Dismiss</button>
  `;
  document.body.appendChild(menu);

  document.getElementById("drag").addEventListener("click", function () {
    // Implement drag functionality here
    document.body.removeChild(menu);
  });

  document.getElementById("not_me").addEventListener("click", function () {
    const existingActivities = document.querySelectorAll(
      "#timeline_block .activity"
    );
    let found = false;
    for (let i = existingActivities.length - 1; i >= 0; i--) {
      if (existingActivities[i] === activity) {
        found = true;
      } else if (found) {
        const existingTop = parseFloat(existingActivities[i].style.top);
        const existingHeight = parseFloat(existingActivities[i].style.height);
        const existingBottom = existingTop + existingHeight;
        const topPosition = parseFloat(activity.style.top);

        if (topPosition < existingBottom && topPosition >= existingTop) {
          showActivityMenu(existingActivities[i]);
          break;
        }
      }
    }
    document.body.removeChild(menu);
  });

  document.getElementById("dismiss").addEventListener("click", function () {
    document.body.removeChild(menu);
  });
}

function parseTime(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  return hours + minutes / 60;
}

document.querySelector("#app").innerHTML = `
  <div>
      <div id="timeline_block"></div>
      <form id="taskForm">
        <label for="task_start">Task Start (hh:mm):</label>
        <input type="text" id="task_start" name="task_start" pattern="\\d{1,2}:\\d{2}" value="${String(
          START_HOUR
        ).padStart(2, "0")}:00" required>
        
        <label for="task_duration">Duration (minutes):</label>
        <input type="number" id="task_duration" name="task_duration" min="1" max="${
          DAY_LENGTH * 60
        }" value="30" required>
        
        <label for="task_name">Task Name:</label>
        <input type="text" id="task_name" name="task_name" required>
        
        <button type="submit">Add Task</button>
      </form>
  </div>
`;

document
  .querySelector("#taskForm")
  .addEventListener("submit", function (event) {
    event.preventDefault();
    const taskStartStr = document.querySelector("#task_start").value;
    const taskStart = parseTime(taskStartStr);
    const taskDuration = document.querySelector("#task_duration").value;
    const taskName = document.querySelector("#task_name").value;
    createActivity(taskStartStr, taskDuration, taskName);
    document.querySelector("#taskForm").reset();
  });

var delta = document.querySelector("#timeline_block").offsetHeight / DAY_LENGTH;
for (let i = 1; i < DAY_LENGTH; i += 1) {
  console.log(i);
  const hour = calculateHour(i + START_HOUR);
  const topPosition = i * delta;
  const hourBlock = createHourBlock(hour, topPosition);
  document.querySelector("#timeline_block").appendChild(hourBlock);
}

// setupCounter(document.querySelector("#counter"));
